<!DOCTYPE HTML>
<html>
<head><meta charset="UTF-8"><title>VITO Data Monitor</title></head>
<body style="font-family: Lekton; font-size: 12pt">
	<h3>&emsp;<a href='/web/index.htm'>Home</a>&emsp;<a href='/files/'>SD-Card</a>&emsp;<a href='/web/vitomon.htm'>Data GUI</a></h3>
	<div>
		<select id="logfiles" name="logfiles" size="1"></select>
		<input type="button" id="prevf" value="Previous day" style="width:150px">
		<input type="button" id="nextf" value="Next day" style="width:150px">
	</div>
	<div style="position:absolute;left:30px;top:120px">	<!-- place holder for canvases -->
		<script type="text/javascript">
			// default canvas sizes
			var canvasWidth = 1200;
			var canvasHeigth = 600;
			// add canvas and data place holder 
			document.write("<canvas id='canvas_1' width="+canvasWidth+" height="+canvasHeigth+
				" style='z-index: 1; box-shadow: 0px 0px 10px 15px #D5D5D5'></canvas>");
			document.write("<div id='container'><textarea id='post_reply' rows='4' cols='100' placeholder='Content goes here'"+
				" style='position:absolute;left:0px;top:"+canvasHeigth+"px; width:"+canvasWidth+"px; height:400px;'></textarea></div>");
		</script>
	</div>
	<div>
	<script type="text/javascript" src="ajax2php.js"></script> <!--// configuration and initiation of plot -->
	<script type="text/javascript">	// configuration and initiation of plot

		var data_array;
		var data_head;
		/*******************************************/
		var ProcessPHPData = function(rply) {
			//alert("got answer from php!");
			document.getElementById("post_reply").value = "";
			document.getElementById("post_reply").value = rply.trim();
			ParseData();
		};
		/*******************************************/
		var ExtractFileList = function(rply) {
			//alert("got answer from php!");
			var eSelect = document.getElementById("logfiles");
			// remove previous elements
			eSelect.length = 0;
			var arr = rply.trim().split("\n");
			arr = arr.reverse();	// reverse array order to have the latest file on top
			var elem = "<option></option>"; // add empty option
			eSelect.insertAdjacentHTML("BeforeEnd", elem);
			for (var fi in arr) {
				// populate option entries
				elem = "<option>"+arr[fi]+"</option>";
				eSelect.insertAdjacentHTML("BeforeEnd", elem);
			}
		};
		/*******************************************/
		function SendRequest(pFile, pParam, pValue, cbFunc)
		{
			var myPhp = new DoPHP();
			myPhp.phpfile = pFile;
			myPhp.postparam = pParam;
			myPhp.postvalue = pValue;
			myPhp.RequestData(cbFunc);
		}
		/*******************************************/
		function RetrieveDataSet()
		{
				var sel = document.getElementById("logfiles");
				var selF = sel.options[sel.selectedIndex].value;	// get the selected file
				//SendRequest("socket_client.php", "readfile", "vito_data_2014-04-06.txt", ProcessPHPData);
				SendRequest("test.txt", "readfile", selF, ProcessPHPData);
		}
		/**********************************************/
		function InitDataSet()
		{	// populate the file selection selector with available files
			SendRequest("socket_client1.php", "getfilelist", ".csv", ExtractFileList);
		}
		/**********************************************/
		function ConvertToMinutes(str)
		{
			var p = str.split(':');
			var	s = 0, m = 1;
			while (p.length > 0) {
				s += m * parseInt(p.pop(), 10);
				m *= 60;
			}
			return s;
		}
		/**********************************************/
		// parse here the data
		/**********************************************/
		function ParseData()
		{	// convert the read data into an array
			data_array = new Array();
			data_head = new Array();
			//if (!repl) {alert("repl is undefined!");	return;}
			var repl = document.getElementById("post_reply").value;
			var arr = repl.split("\n");
			//alert ("array length : "+arr.length); //return;
			for (var indx in arr)
			{
				// remove any line endings ' ,'
				subarr = arr[indx].trim();
				if ( subarr.charAt(subarr.length-1)==',' ) subarr = subarr.slice(0,-1);
				subarr = subarr.split(",");
				//	alert ("subarr: "+subarr);	return;
				if ( subarr[0]=="Time" ) { // header row with parameters
					// copy parameters
					data_head = subarr;
					//alert ("data head: "+data_head);	return;
					continue;
				}
				//alert ("subarray elements : "+subarr.length);	return;
				var tmps = subarr[0];	// time mm:hh(:)
				indx --;
				// convert time info into minute value
				data_array[indx] = subarr;
				data_array[indx][0] = ConvertToMinutes(tmps);
				if (!data_head[0]) data_head[0] = "Time";
				// extract variables
				for (var inds in subarr)
				{
					if (inds==0) continue;	// this is time, so skip it
					var datVal = subarr[inds];
					if (datVal==0) break;
					datVal = parseFloat(datVal);
					data_array[indx][inds] = datVal;	// take the value
				}
				//alert ("data element '"+indx+"': "+data_array[indx]);	return;
			}
					//alert ("data element 0: "+data_array[0]);	return;
			// plot data
			DrawPlots();
		}
		/**********************************************/
		function TakeNextOption(dir)
		{
			var sel = document.getElementById("logfiles");
			var indx = sel.selectedIndex;
			if ( indx==0 ) dir = 1;
			//alert("sel.length: "+sel.length);
			if ( dir<0 && indx>1 ) {
				indx -= 1;
			} else if ( dir>0 && indx<sel.length ) {
				indx += 1;
			}
			if ( indx<2 )	document.getElementById("nextf").disabled = "true";
			else	document.getElementById("nextf").disabled = "";
			if ( indx==(sel.length-1) )	document.getElementById("prevf").disabled = "true";
			else	document.getElementById("prevf").disabled = "";
			
			if ( indx != sel.selectedIndex )	{	// on selection change
				sel.selectedIndex = indx;
				RetrieveDataSet();
			}
			//var selF = sel.options[indx].value;	// get the selected file
		}
		/**********************************************/
		/**********************************************/
		document.getElementById("logfiles").onchange = RetrieveDataSet;
		//document.getElementById("post_reply").onchange = ParseData;
		document.getElementById("prevf").onclick = function(){TakeNextOption(+1);};
		document.getElementById("nextf").onclick = function(){TakeNextOption(-1);};
		InitDataSet();
		/**********************************************/
		/**********************************************/
		var myVar = setInterval(function(){ TakeNextOption(0); clearInterval(myVar);},1000);
	</script>
	</div>
	<div>
	<script src="vitoplot.js"></script>
	<script type="text/javascript">
		// configuration and initiation of plot
		//document.getElementById("drawing").onclick = DrawPlots;
		var plotColor = ['#FF0000', '#00CC00', '#0000FF', '#FF8800', '#00CC88', '#8800FF', '#CCCC00', '#0088CC', '#CC00CC'];
		var myp;
		/**********************************************/
		function DrawPlots()
		{
			// configuration and initiation of plot
			myp = new MakeDraw(); // create drawing object
			myp.id = "canvas_1"; // tell the object where would you like to draw
			myp.data = data_array; // pass n-dimensional array with data you'd like to draw, index 0 shall contain x-axis data.
			myp.plotColor = plotColor;
			myp.labels = data_head; // pass plot labels
			myp.replot = ReDrawPlots; // prepare graphics
			if (!document.getElementById("canvas_2")) {
				myp.prepUI(); // prepare graphics
				myp.plot(); // drawing
			} else
				myp.refresh();
		}
		/**********************************************/
		function ReDrawPlots()
		{
			myp.refresh();
		}
		/**********************************************/
	</script>
	</div>
</body>
</html>
